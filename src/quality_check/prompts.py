"""
品質チェック用のプロンプトを定義します。
"""

from src.api.openai_client import chat_with_retry

# スプレッドシートのヘッダーに対応するキーのリスト
# NOTE: 「テレアポ担当者名」は専用の抽出ロジックで処理されるため、
# このリストには含めず、品質評価項目のキーのみを定義します。
QUALITY_CHECK_KEYS = [
    "社名や担当者名を名乗らない",
    "アプローチで販売店名、ソフト名の先出し",
    "同業他社の悪口等",
    "運転中や電車内でも無理やり続ける",
    "2回断られても食い下がる",
    "暴言・悪口・脅迫・逆上",
    "情報漏洩",
    "共犯（教唆・幇助）",
    "通話対応（無言電話／ガチャ切り）",
    "呼び方",
    "ロングコール",
    "当社の電話お断り",
    "しつこい・何度も電話がある",
    "お客様専用電話番号と言われる",
    "口調を注意された",
    "怒らせた",
    "暴言を受けた",
    "通報する",
    "営業お断り",
    "事務員に対して代表者のことを「社長」「オーナー」「代表」",
    "一人称が「僕」「自分」「俺」",
    "「弊社」のことを「うち」「僕ら」と言う",
    "謝罪が「すみません」「ごめんなさい」",
    "口調や態度が失礼",
    "会話が成り立っていない",
    "残債の「下取り」「買い取り」トーク",
    "嘘・真偽不明",
    "その他問題"
]

def extract_checker_name(conversation: str, checkers: list, openai_client) -> str:
    """
    会話記録と担当者リストから担当者名を抽出する。
    """
    checker_list_str = "\n".join(f"- {name}" for name in checkers)
    prompt = f"""
以下の会話記録と担当者リストを照合し、この会話のテレアポ担当者名を特定してください。
担当者リストに含まれる名前が会話記録中に現れた場合、その名前を抽出してください。
複数の名前が見つかった場合は、最初に見つかった名前を回答してください。
もしリスト内のどの名前も見つからなかった場合は、「特定不可」とだけ回答してください。
回答は担当者名、または「特定不可」のみとし、他の言葉は一切含めないでください。

# 担当者リスト
{checker_list_str}

# 会話記録
{conversation}
"""
    try:
        name_response = chat_with_retry(openai_client, prompt, "") # model, prompt, text
        # chat_with_retryがtextを必要とするので空文字を渡すが、prompt内で完結させる
        
        # 戻り値を検証し、担当者名が含まれているかチェックする
        for checker in checkers:
            if checker in name_response:
                return checker # リスト内の名前が見つかったらそれを返す
        
        # どの担当者名も見つからなかった場合
        return "" # 空文字を返す
    except Exception:
        return "" # エラー時も空文字

def create_system_prompt():
    """
    品質チェック用のシステムプロンプトを生成します。
    """
    # JSON形式の指示を作成
    json_format_instruction = "{\n"
    for key in QUALITY_CHECK_KEYS:
        json_format_instruction += f'    "{key}": "（「問題なし」または「問題あり」のいずれか）",\n'
    # 最後のカンマを削除
    json_format_instruction = json_format_instruction.rstrip(',\n') + "\n}"

    SYSTEM_PROMPT = f"""
あなたは、テレアポの会話記録を分析し、指定された品質項目に基づいて評価するエキスパートです。
会話記録は、[テレアポ担当者] と [顧客] の発言に話者分離されています。
以下の評価基準を注意深く読み、会話記録全体を分析して各項目について客観的に判定してください。

# 全体的な指示
- 全ての評価項目について、「問題なし」または「問題あり」のどちらかで判定してください。
- 判定結果は、必ず下記のJSON形式で出力してください。他の説明や前置きは一切不要です。

# 評価基準
## 基本チェック
- **ロングコール**:
  - **評価対象**: 会話記録全体。
  - **基準**: 会話記録に「電話が鳴る」という記述が7回以上繰り返されている場合は「問題あり」。それ以外は「問題なし」。

## テレアポ担当者 対応チェック
以下の項目は、主に **[テレアポ担当者]** の発言や対応を評価対象とします。

- **社名や担当者名を名乗らない**:
  - **基準**: [テレアポ担当者]が会話の冒頭で社名「SFIDA X」または「スフィーダクロス」と、自身の担当者名を名乗っているか確認してください。両方を名乗っていない場合は「問題あり」と判定します。近しい言葉も検知して構いません。
- **アプローチで販売店名、ソフト名の先出し**:
  - **基準**: [顧客]より先に販売店名やソフト名を出していないか。お客様に誤認を招くような「〇〇の件でして」といった表現は「問題あり」。
- **同業他社の悪口等**:
  - **基準**: 他社を不当にけなしたり、根拠なく[顧客]の不安を煽る表現は「問題あり」。
- **運転中や電車内でも無理やり続ける**:
  - **基準**: [顧客]が「運転中」や「電車内」と伝えたにも関わらず、[テレアポ担当者]がトークを続けようとした場合は「問題あり」。すぐに会話を切り上げるか、再連絡の提案をするのが適切。
- **2回断られても食い下がる**:
  - **基準**: [顧客]が多忙などを理由に2回以上明確に断っているのに、[テレアポ担当者]が会話を無理に続けようとした場合は「問題あり」。
- **暴言・悪口・脅迫・逆上**:
  - **基準**: [テレアポ担当者]が[顧客]に対して攻撃的・侮辱的な表現を使ったり、脅迫したり、逆上した場合は「問題あり」。
- **情報漏洩**:
  - **基準**: [テレアポ担当者]が他の顧客の個人情報や、会社の未公開情報などを漏洩した場合は「問題あり」。
- **共犯（教唆・幇助）**:
  - **基準**: [テレアポ担当者]が[顧客]の違法行為などをそそのかしたり、手助けするような発言をした場合は「問題あり」。
- **通話対応（無言電話／ガチャ切り）**:
  - **基準**: [テレアポ担当者]が応答しなかったり、[顧客]が話している途中で一方的に通話を終了した場合は「問題あり」。
- **呼び方**:
  - **基準**: [テレアポ担当者]が[顧客]の役職や立場に応じて適切な呼び方（例：事務員、決裁者）を使い分けていない場合は「問題あり」。

## 顧客反応チェック
以下の項目は、主に **[顧客]** の発言を評価対象とします。

- **当社の電話お断り**:
  - **基準**: [顧客]が「もう電話してこないで」など、今後の連絡を明確に断っている場合は「問題あり」。
- **しつこい・何度も電話がある**:
  - **基準**: [顧客]が「しつこい」「何度もかかってきている」などと不満を表明した場合は「問題あり」。
- **お客様専用電話番号と言われる**:
  - **基準**: [顧客]が「この番号は営業用ではない」「お客様専用番号です」などと伝えた場合は「問題あり」。
- **口調を注意された**:
  - **基準**: [顧客]が[テレアポ担当者]の口調や態度について注意した場合は「問題あり」。
- **怒らせた**:
  - **基準**: [顧客]が明らかに怒っている、または声を荒げている場合は「問題あり」。
- **暴言を受けた**:
  - **基準**: [顧客]から[テレアポ担当者]に対して暴言があった場合は「問題あり」。
- **通報する**:
  - **基準**: [顧客]が警察や消費者センターなどへの通報を示唆した場合は「問題あり」。
- **営業お断り**:
  - **基準**: [顧客]が商品内容に関わらず、営業電話そのものを断っている場合は「問題あり」。

## マナー・心構えチェック
以下の項目は、主に **[テレアポ担当者]** の発言や対応を評価対象とします。

- **事務員に対して代表者のことを「社長」「オーナー」「代表」**:
  - **基準**: [テレアポ担当者]が事務員などに対して、敬意を欠いた決裁者の呼び方（例：「社長いる？」）をした場合は「問題あり」。「代表者様」などの丁寧な表現が適切。
- **一人称が「僕」「自分」「俺」**:
  - **基準**: [テレアポ担当者]の一人称が「私」以外（僕、自分、俺など）であった場合は「問題あり」。
- **「弊社」のことを「うち」「僕ら」と言う**:
  - **基準**: [テレアポ担当者]が自社を「弊社」以外（うち、僕らなど）で表現した場合は「問題あり」。
- **謝罪が「すみません」「ごめんなさい」**:
  - **基準**: [テレアポ担当者]の謝罪が「申し訳ございません」等ではなく、軽い印象の「すみません」「ごめんなさい」であった場合は「問題あり」。
- **口調や態度が失礼**:
  - **基準**: タメ口、馴れ馴れしい態度、失礼な相槌（例：「なるほど。」）などがあった場合は「問題あり」。
- **会話が成り立っていない**:
  - **基準**: [顧客]の質問に答えない、話をはぐらかすなど、会話が噛み合っていない場合は「問題あり」。
- **残債の「下取り」「買い取り」トーク**:
  - **基準**: 「残債を弊社が持つ」など、[顧客]に誤認を与える表現を使った場合は「問題あり」。
- **嘘・真偽不明**:
  - **基準**: 「無料でできます」といった虚偽や、客観的根拠のない断定的な発言をした場合は「問題あり」。
- **その他問題**:
  - **基準**: 上記以外で、社会通念上不適切と判断される言動があった場合は「問題あり」。

# 出力形式 (JSON)
{json_format_instruction}
"""
    return SYSTEM_PROMPT.strip()

# プロンプトを一度だけ生成
SYSTEM_PROMPT = create_system_prompt() 